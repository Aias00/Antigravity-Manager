# é…é¢é˜ˆå€¼æ£€æŸ¥åŠŸèƒ½ - ä¿®å¤è¯´æ˜

## ğŸ› å‘ç°çš„é—®é¢˜

é€šè¿‡åˆ†æç”¨æˆ·æä¾›çš„æ—¥å¿—ï¼Œå‘ç°é…é¢é˜ˆå€¼æ£€æŸ¥åŠŸèƒ½**æ²¡æœ‰ç”Ÿæ•ˆ**ã€‚

### é—®é¢˜åˆ†æ

**é¢„æœŸè¡Œä¸º**ï¼š
- æ—¥å¿—ä¸­åº”è¯¥çœ‹åˆ°ï¼š`Account xxx@gmail.com Claude quota (84%) is below threshold (86%), skipping`
- é…é¢ä½äºé˜ˆå€¼çš„è´¦å·åº”è¯¥è¢«è·³è¿‡

**å®é™…æƒ…å†µ**ï¼š
- æ—¥å¿—ä¸­æ²¡æœ‰ä»»ä½•é…é¢æ£€æŸ¥çš„è¾“å‡º
- æ‰€æœ‰è´¦å·éƒ½è¢«æ­£å¸¸ä½¿ç”¨

### æ ¹æœ¬åŸå› 

åŸå§‹å®ç°ä¸­ï¼Œé…é¢æ£€æŸ¥é€»è¾‘ä¾èµ– `quota_group` å‚æ•°ï¼š

```rust
if quota_group == "claude" || quota_group.starts_with("claude") {
    // æ£€æŸ¥ Claude é…é¢
}
```

ä½†å®é™…è°ƒç”¨æ—¶ï¼Œ`quota_group` çš„å€¼æ˜¯ `config.request_type`ï¼Œå…¶å¯èƒ½çš„å€¼ä¸ºï¼š
- `"agent"` - æ™®é€šè¯·æ±‚
- `"web_search"` - è”ç½‘æœç´¢
- `"image_gen"` - å›¾ç‰‡ç”Ÿæˆ

**æ°¸è¿œä¸ä¼šæ˜¯ `"claude"`**ï¼Œæ‰€ä»¥æ£€æŸ¥é€»è¾‘æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å‰
```rust
fn is_quota_below_threshold(&self, token: &ProxyToken, quota_group: &str) -> bool {
    // ...
    let current_quota_percent = if quota_group == "claude" || quota_group.starts_with("claude") {
        // æå– Claude é…é¢
        quota_data.get("models")...
    } else {
        None  // âŒ æ°¸è¿œèµ°è¿™ä¸ªåˆ†æ”¯ï¼
    };
}
```

### ä¿®æ”¹å
```rust
fn is_quota_below_threshold(&self, token: &ProxyToken, _quota_group: &str) -> bool {
    // ...
    // âœ… ç›´æ¥æ£€æŸ¥é…é¢æ•°æ®ä¸­çš„ Claude æ¨¡å‹ï¼Œä¸ä¾èµ–å‚æ•°
    let current_quota_percent = quota_data.get("models")
        .and_then(|m| m.as_object())
        .and_then(|models| {
            for (model_name, model_data) in models {
                if model_name.contains("claude") {
                    if let Some(percent) = model_data.get("quota_percent").and_then(|v| v.as_i64()) {
                        return Some(percent as i32);
                    }
                }
            }
            None
        });
}
```

### å…³é”®æ”¹è¿›

1. **ç§»é™¤å¯¹ `quota_group` çš„ä¾èµ–**
   - ä¸å†æ£€æŸ¥å‚æ•°å€¼
   - ç›´æ¥éå†é…é¢æ•°æ®ä¸­çš„æ‰€æœ‰æ¨¡å‹

2. **æå‡æ—¥å¿—çº§åˆ«**
   - ä» `debug!` æ”¹ä¸º `warn!`
   - ç¡®ä¿é…é¢æ£€æŸ¥ä¿¡æ¯å¯è§

3. **æ”¹è¿›æ—¥å¿—æ ¼å¼**
   ```
   Account xxx@gmail.com Claude quota (84%) is below threshold (86%), skipping
   ```

---

## ğŸ“Š ä¿®å¤åçš„è¡Œä¸º

### åœºæ™¯ï¼šä¸‰ä¸ªè´¦å·

| è´¦å· | é˜ˆå€¼è®¾ç½® | å½“å‰é…é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|---------|---------|--------|--------|
| è´¦å·1 | 86% | 84% | âŒ è¢«ä½¿ç”¨ | âœ… **è·³è¿‡** + æ—¥å¿— |
| è´¦å·2 | æ—  | 36% | âœ… è¢«ä½¿ç”¨ | âœ… è¢«ä½¿ç”¨ |
| è´¦å·3 | æ—  | 79% | âŒ è¢«ä½¿ç”¨ | âœ… **è·³è¿‡**ï¼ˆè´¦å·2è¶³å¤Ÿï¼‰ |

### é¢„æœŸæ—¥å¿—è¾“å‡º

```
2026-01-02T20:00:00 WARN Account user1@gmail.com Claude quota (84%) is below threshold (86%), skipping
2026-01-02T20:00:00 INFO âœ“ Using account: user2@gmail.com (type: agent)
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. è®¾ç½®é˜ˆå€¼
åœ¨è´¦å·è®¾ç½®ä¸­ï¼Œä¸ºè´¦å·1è®¾ç½®é˜ˆå€¼ **90%**

### 2. ç¡®è®¤å½“å‰é…é¢
ç¡®ä¿è´¦å·1çš„ Claude é…é¢ä½äº 90%ï¼ˆä¾‹å¦‚ 84%ï¼‰

### 3. å‘èµ·è¯·æ±‚
ä½¿ç”¨ Claude æ¨¡å‹å‘èµ·è¯·æ±‚

### 4. æ£€æŸ¥æ—¥å¿—
åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
WARN Account xxx@gmail.com Claude quota (84%) is below threshold (90%), skipping
INFO âœ“ Using account: yyy@gmail.com (type: agent)
```

### 5. éªŒè¯è¡Œä¸º
- è´¦å·1åº”è¯¥è¢«è·³è¿‡
- ç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨è´¦å·2æˆ–è´¦å·3

---

## ğŸ“ é…é¢æ•°æ®æ ¼å¼

ç³»ç»Ÿä»è´¦å· JSON æ–‡ä»¶çš„ `quota.models` ä¸­æå–é…é¢ï¼š

```json
{
  "id": "account-id",
  "email": "user@gmail.com",
  "min_quota_threshold": 86,
  "quota": {
    "models": {
      "claude-3-5-sonnet-20241022": {
        "quota_percent": 84,
        "remaining": "84%"
      },
      "claude-sonnet-4-5": {
        "quota_percent": 84,
        "remaining": "84%"
      }
    }
  }
}
```

**æ£€æŸ¥é€»è¾‘**ï¼š
- éå† `quota.models` ä¸­çš„æ‰€æœ‰æ¨¡å‹
- æ‰¾åˆ°åŒ…å« `"claude"` çš„æ¨¡å‹å
- æå– `quota_percent` å€¼
- ä¸ `min_quota_threshold` æ¯”è¾ƒ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é˜ˆå€¼å•ä½**ï¼šç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
2. **é…é¢æ•°æ®æ¥æº**ï¼šä»é…é¢åˆ·æ–°æ¥å£è·å–
3. **æ£€æŸ¥æ—¶æœº**ï¼šæ¯æ¬¡é€‰æ‹©è´¦å·æ—¶éƒ½ä¼šæ£€æŸ¥
4. **æ—¥å¿—çº§åˆ«**ï¼šWARNï¼ˆç¡®ä¿å¯è§ï¼‰
5. **æ— é…é¢æ•°æ®**ï¼šå¦‚æœè´¦å·æ²¡æœ‰é…é¢æ•°æ®ï¼Œå…è®¸ä½¿ç”¨ï¼ˆé¿å…è¯¯æ‹¦æˆªï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **é‡æ–°ç¼–è¯‘**ï¼š
   ```bash
   cd src-tauri
   cargo build --release
   ```

2. **é‡å¯åº”ç”¨**

3. **åˆ·æ–°é…é¢**ï¼š
   - åœ¨ UI ä¸­ç‚¹å‡»"åˆ·æ–°é…é¢"
   - ç¡®ä¿æ‰€æœ‰è´¦å·éƒ½æœ‰æœ€æ–°çš„é…é¢æ•°æ®

4. **è®¾ç½®é˜ˆå€¼**ï¼š
   - ä¸ºéœ€è¦ä¿æŠ¤çš„è´¦å·è®¾ç½®é˜ˆå€¼

5. **è§‚å¯Ÿæ—¥å¿—**ï¼š
   - å‘èµ·è¯·æ±‚
   - æŸ¥çœ‹æ˜¯å¦æœ‰é…é¢æ£€æŸ¥çš„ WARN æ—¥å¿—

---

**ä¿®å¤ç‰ˆæœ¬**ï¼šv3.3.9+  
**ä¿®å¤æ—¥æœŸ**ï¼š2026-01-02  
**ç›¸å…³æ–‡ä»¶**ï¼š`src-tauri/src/proxy/token_manager.rs`  
**ä¿®å¤ç±»å‹**ï¼šé€»è¾‘é”™è¯¯ä¿®å¤

# 模型配额优化指南：如何节省 Google Claude 额度

## 问题分析

最近发现 Google Claude 模型（通过 Vertex AI）的配额消耗非常迅速。分析发现，这主要是因为**"Claude 优先"策略**导致的。

在默认的自动降级模式下：
- 所有请求都会**优先尝试 Claude 模型**。
- 只有配额耗尽时，才会切换到 Gemini。
- 这意味着 Cursor 等 IDE 产生的大量高频请求（索引、补全、Linting）都会直接消耗 Claude 配额。

## 解决方案：使用"精确映射"强制分流

为了节省宝贵的 Claude 配额，我们引入了**基于映射类型的智能路由策略**：

### 1. 自动降级模式（默认，质量优先）
**适用场景**：日常对话、复杂推理。
**触发条件**：使用 **"分组映射"**（如 `Claude 4.5 系列` -> `Gemini Pro`）。
**行为**：
1. 优先尝试原始 Claude 模型。
2. 只有当配额耗尽 (429) 时，才自动切换到 Gemini。
**优点**：保证最佳的模型效果，Claude 能用则用。

### 2. 强制分流模式（省流优先）
**适用场景**：IDEA/Cursor 后台索引、高频补全、自动化任务。
**触发条件**：配置 **"精确映射"**（Custom Mapping）。
**行为**：
1. **直接使用映射后的模型**（如 Gemini）。
2. **完全不尝试**原始 Claude 模型。
**优点**：**完全不消耗** Claude 配额，将高频请求分流给廉价/免费的 Gemini 模型。

## 操作指南

### 场景 A：我想省着用 Claude
如果您希望保留 Claude 配额给关键对话，而让 Cursor 的杂活走 Gemini：

1. 打开"模型路由中心"。
2. 找到 **"自定义模型映射"** (Custom Mapping) 区域。
3. 添加精确映射规则：
   - 原始模型：`claude-sonnet-4-5`（或其他您想分流的模型）
   - 目标模型：`gemini-3-pro-high`
4. 保存配置。

**效果**：所有对 `claude-sonnet-4-5` 的请求都会**立即、强制**转发给 `gemini-3-pro-high`，**不会消耗**任何 Claude 配额。

### 场景 B：我想优先用 Claude，没了再用 Gemini
如果您希望尽可能使用 Claude：

1. 确保 **"自定义模型映射"** 中**没有**针对该模型的配置。
2. 仅在 **"Anthropic 映射"** (分组映射) 中配置：
   - Claude 4.5 系列 -> `gemini-3-pro-high`

**效果**：请求将优先消耗 Claude 配额，耗尽后自动由 Gemini 接手。

## 总结

| 映射类型 | 配置位置 | 路由策略 |配额消耗 | 推荐场景 |
| :--- | :--- | :--- | :--- | :--- |
| **精确映射** | 自定义模型映射 | **强制转发** (直接走 Gemini) | **0%** Claude | 高频请求、后台任务、省流 |
| **分组映射** | Anthropic 映射 | **自动降级** (先 Claude 后 Gemini) | **100%** Claude (直到耗尽) | 核心对话、复杂任务 |

通过这种方式，您可以灵活控制哪些请求"吃好点"（走 Claude），哪些请求"吃饱就行"（走 Gemini）。

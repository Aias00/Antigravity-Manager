# z.ai è‡ªåŠ¨é™çº§åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

å®ç°**ä¼˜å…ˆä½¿ç”¨ Claude APIï¼Œé…é¢è€—å°½æ—¶è‡ªåŠ¨é™çº§åˆ° Gemini** çš„åŠŸèƒ½ã€‚

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. åç«¯é…ç½® (`src-tauri/src/proxy/config.rs`)

- âœ… åœ¨ `ZaiConfig` ä¸­æ·»åŠ  `fallback_to_mapping: bool` å­—æ®µ
- âœ… é»˜è®¤å€¼è®¾ç½®ä¸º `false`

### 2. åç«¯é€»è¾‘ (`src-tauri/src/proxy/handlers/claude.rs`)

- âœ… ä¿®æ”¹ z.ai è°ƒç”¨é€»è¾‘ï¼Œä¸å†ç›´æ¥è¿”å›å“åº”
- âœ… æ·»åŠ é”™è¯¯æ£€æµ‹ï¼ˆ429 å’Œ 5xxï¼‰
- âœ… æ·»åŠ æ˜ å°„æ£€æŸ¥é€»è¾‘
- âœ… å®ç°è‡ªåŠ¨é™çº§åˆ° Gemini æµç¨‹
- âœ… æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

## ğŸ“‹ éœ€è¦æ‰‹åŠ¨å®Œæˆçš„æ­¥éª¤

### å‰ç«¯ UI æ·»åŠ 

åœ¨ `src/pages/ApiProxy.tsx` ä¸­æ·»åŠ é™çº§é€‰é¡¹å¼€å…³ã€‚

**ä½ç½®**ï¼šç¬¬ 896 è¡Œä¹‹åï¼Œ`{/* Model Mapping Section */}` ä¹‹å‰

**ä»£ç **ï¼šå·²ä¿å­˜åˆ° `docs/features/ui-snippet-fallback-option.tsx`

ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ã€‚

## ğŸš€ ä½¿ç”¨æµç¨‹

### æ­¥éª¤ 1ï¼šé…ç½® z.ai

```yaml
proxy:
  zai:
    enabled: true
    api_key: "your-z.ai-api-key"
    dispatch_mode: "exclusive"  # ä¼˜å…ˆä½¿ç”¨ z.ai
    fallback_to_mapping: true   # â† æ–°å¢ï¼šå¯ç”¨é™çº§
```

### æ­¥éª¤ 2ï¼šé…ç½®æ¨¡å‹æ˜ å°„

åœ¨ç•Œé¢çš„"æ¨¡å‹è·¯ç”±ä¸­å¿ƒ"è®¾ç½®ï¼š
- Claude 4.5 ç³»åˆ— â†’ `gemini-3-pro-high`
- Claude 3.5 ç³»åˆ— â†’ `gemini-2.5-flash`

### æ­¥éª¤ 3ï¼šæ·»åŠ  Google è´¦å·

ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ª Google è´¦å·ç”¨äº Gemini è¯·æ±‚ã€‚

### æ­¥éª¤ 4ï¼šæµ‹è¯•

1. å‘é€ Claude è¯·æ±‚ â†’ ä½¿ç”¨ z.ai
2. ç­‰å¾… z.ai é…é¢è€—å°½ â†’ è‡ªåŠ¨é™çº§åˆ° Gemini
3. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤é™çº§æˆåŠŸ

## ğŸ“Š å·¥ä½œæµç¨‹å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚ Claude
    â†“
æ£€æŸ¥ z.ai é…ç½®
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½¿ç”¨ z.ai API      â”‚
â”‚  (çœŸå® Claude)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ£€æŸ¥å“åº”çŠ¶æ€
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆåŠŸï¼Ÿ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  YES â†’ è¿”å›å“åº”     â”‚
â”‚  NO  â†’ æ£€æŸ¥é™çº§     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯ç”¨é™çº§ï¼Ÿ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NO  â†’ è¿”å›é”™è¯¯     â”‚
â”‚  YES â†’ ç»§ç»­         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥æ˜ å°„           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ— æ˜ å°„ â†’ è¿”å›é”™è¯¯  â”‚
â”‚  æœ‰æ˜ å°„ â†’ é™çº§      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½¿ç”¨ Gemini API    â”‚
â”‚  (Google è´¦å·)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å› Claude æ ¼å¼å“åº”
```

## ğŸ¨ é™çº§è§¦å‘æ¡ä»¶

| çŠ¶æ€ç  | è¯´æ˜ | æ˜¯å¦é™çº§ |
|--------|------|----------|
| 200-299 | æˆåŠŸ | âŒ ä¸é™çº§ |
| 400 | è¯·æ±‚é”™è¯¯ | âŒ ä¸é™çº§ |
| 401 | è®¤è¯å¤±è´¥ | âŒ ä¸é™çº§ |
| **429** | **é…é¢è€—å°½** | âœ… **é™çº§** |
| **5xx** | **æœåŠ¡é”™è¯¯** | âœ… **é™çº§** |

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸé™çº§
```
[Claude] z.ai returned 429, checking for fallback to Gemini mapping
[Claude] z.ai quota exhausted, falling back to Gemini mapping: claude-sonnet-4-5 -> gemini-3-pro-high
[Router] ä½¿ç”¨ Anthropic ç³»åˆ—æ˜ å°„: claude-sonnet-4-5 -> gemini-3-pro-high
Using account: user@gmail.com for request (type: agent)
[Claude] Request finished. Model: gemini-3-pro-high, Tokens: In 100, Out 200
```

### æ— æ³•é™çº§ï¼ˆæ— æ˜ å°„ï¼‰
```
[Claude] z.ai returned 429, checking for fallback to Gemini mapping
[Claude] z.ai quota exhausted but no valid Gemini mapping found, returning error
```

### é™çº§åŠŸèƒ½æœªå¯ç”¨
```
[Claude] z.ai returned 429
(ç›´æ¥è¿”å› 429 é”™è¯¯ç»™å®¢æˆ·ç«¯)
```

## ğŸ’° é…é¢æ¶ˆè€—å¯¹æ¯”

| åœºæ™¯ | z.ai é…é¢ | Google é…é¢ |
|------|-----------|-------------|
| æ­£å¸¸ä½¿ç”¨ | âœ… æ¶ˆè€— | âŒ ä¸æ¶ˆè€— |
| z.ai è€—å°½ï¼ˆé™çº§ï¼‰ | âŒ ä¸æ¶ˆè€— | âœ… æ¶ˆè€— |
| z.ai è€—å°½ï¼ˆæ— é™çº§ï¼‰ | âŒ ä¸æ¶ˆè€— | âŒ ä¸æ¶ˆè€—ï¼ˆè¿”å›é”™è¯¯ï¼‰ |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»åŒæ—¶é…ç½®**ï¼š
   - z.ai API Key
   - Gemini æ¨¡å‹æ˜ å°„
   - Google è´¦å·

2. **æ˜ å°„è¦æ±‚**ï¼š
   - ç›®æ ‡æ¨¡å‹å¿…é¡»ä»¥ `gemini-` å¼€å¤´
   - æ˜ å°„ä¸èƒ½ä¸ºç©ºå­—ç¬¦ä¸²

3. **é™çº§æ˜¯å•å‘çš„**ï¼š
   - z.ai æ¢å¤åä¸ä¼šè‡ªåŠ¨åˆ‡å›
   - éœ€è¦é‡å¯ä»£ç†æœåŠ¡æ‰ä¼šé‡æ–°ä½¿ç”¨ z.ai

4. **å“åº”æ ¼å¼**ï¼š
   - é™çº§åä»ç„¶è¿”å› Claude API æ ¼å¼
   - å®¢æˆ·ç«¯æ— æ„ŸçŸ¥

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†å®ç°æŒ‡å—ï¼š`docs/features/zai-fallback-to-gemini.md`
- UI ä»£ç ç‰‡æ®µï¼š`docs/features/ui-snippet-fallback-option.tsx`
- Claude è¯·æ±‚æµç¨‹åˆ†æï¼š`docs/analysis/claude-request-flow.md`

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šé™çº§æ²¡æœ‰ç”Ÿæ•ˆ

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… `fallback_to_mapping` æ˜¯å¦è®¾ç½®ä¸º `true`
2. âœ… æ˜¯å¦é…ç½®äº†æœ‰æ•ˆçš„ Gemini æ˜ å°„
3. âœ… æ˜ å°„çš„ç›®æ ‡æ¨¡å‹æ˜¯å¦ä»¥ `gemini-` å¼€å¤´
4. âœ… æ˜¯å¦æœ‰å¯ç”¨çš„ Google è´¦å·
5. âœ… æ˜¯å¦é‡å¯äº†ä»£ç†æœåŠ¡

### é—®é¢˜ï¼šä¸€ç›´ä½¿ç”¨ Geminiï¼Œä¸ä½¿ç”¨ z.ai

**å¯èƒ½åŸå› **ï¼š
1. `dispatch_mode` è®¾ç½®é”™è¯¯ï¼ˆåº”è¯¥æ˜¯ `exclusive` æˆ– `pooled`ï¼‰
2. z.ai æœªå¯ç”¨ï¼ˆ`enabled: false`ï¼‰
3. z.ai API Key æ— æ•ˆ

### é—®é¢˜ï¼šé™çº§åæŠ¥é”™

**å¯èƒ½åŸå› **ï¼š
1. Google è´¦å·é…é¢ä¹Ÿè€—å°½
2. Google è´¦å·æœªæˆæƒ
3. æ˜ å°„çš„æ¨¡å‹ä¸å­˜åœ¨

æŸ¥çœ‹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
